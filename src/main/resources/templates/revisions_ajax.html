<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>LevelOut-Web</title>
	<link rel="stylesheet" th:href="@{/css/main.css}" />
</head>

<body>
<div style="text-align: center;">
	<h1>
		<a href="https://www.uni-weimar.de/en/university/news/bauhausjournal-online/titel/levelout-project-launch-indoor-and-outdoor-smart-navigation/" target="_blank">
			LEVELOUT
		</a>
	</h1>
</div>

<h1><u>IFC</u></u></h1>
<div id="revisionUpload">
	<input th:attr="id=|file_upload|" type="file" style="width: 200px"/>
	<button name="button" value="OK" type="button" th:attr="onclick=|startUpload()|">Upload New Revision</button>

	<div th:attr="id=|progress_status|" class="progress_status">
		<div th:attr="id=|progress|" class="progress"></div>
	</div>
</div>
<div id="revisionsDetails">
	<table>
		<tr><th>Revision ID</th><th>Revision Description</th><th>Reports</th><th>Map</th></tr>

		<th:block th:each="revision : ${revisions}">
			<tr>
				<td><p th:text="${revision.revisionId}"></p></td>
				<td><p th:text="${revision.description}"></p></td>
				<td>
					<div th:each="report : ${revision.reports}">
						<button th:text="${report.value}" th:attr="onclick=|downloadReport('${report.key}', '${report.value}')|" ></button>
					</div>
				</td>
				<td><p th:text="${revision.map}"></p></td>
			</tr>
		</th:block>
	</table>
</div>

<script>
	var contextRoot = '[[@{/}]]'.replace(/\/$/, "");
	function refreshPage(){
        window.location.reload();
    }

	function update(data) {
		var element = document.getElementById("progress");
		element.style.display = "block";
		fetch(contextRoot+"/process/status/"+data.topicId, {
			method: "get"
		})
		.then(function(response) {
		  response.json().then(function(json){
		  	if (json.percentage >= 100 && json.actionState.toString() == "FINISHED") {
				console.log(json);
				element.style.width =  "100%";
				element.innerHTML = json.title + ":" + "100%";
				setTimeout(function(){
					alert("Finished Uploading");
					element.style.display = "none";
					refreshPage();
				},1000);
			} else {
				console.log(json);
				element.style.width = json.percentage * 1 + "%";
				element.innerHTML = json.title + ":" + json.percentage  + "%";
				update(json);
			}
		  });
		}).catch(err => alert(err.error));
	}

	function startUpload() {
		const inputFile = document.getElementById("file_upload");
		const encodedUrl = encodeURI("/process/prepareCheckIn?file="+inputFile.value);
		fetch(contextRoot+encodedUrl, {
			method: "post"
		})
		.then(function(response) {
		  response.json().then(function(json){
		  	uploadFile(json);
		  	update(json);
		  });
		}).catch(err => alert(err.error));
	}

	function uploadFile(data) {
		const inputFile = document.getElementById("file_upload");
		const formData = new FormData();
		for (const file of inputFile.files) {
			formData.append("file", file);
		}
		fetch(contextRoot+"/process/checkIn/"+data.topicId, {
			method: "post",
			body: formData
		}).catch(err => alert(err.error));
	}

	function downloadReport(reportId, title) {
		fetch(contextRoot+'/project/download/report/'+reportId)
		.then(response => {
			if (!response.ok) {
			  throw new Error(response);
			}
			// Extract filename from header
			const filename = response.headers.get('content-disposition')
			  .split(';')
			  .find(n => n.includes('filename='))
			  .replace('filename=', '')
			  .trim();
			response.blob().then(blob => {
				const url = window.URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.style.display = 'none';
				a.href = url;
				// the filename you want
				a.download = filename;
				document.body.appendChild(a);
				a.click();
				window.URL.revokeObjectURL(url);
				alert('Report: '+filename+' has downloaded!');
			})
		})
  	}
	</script>

</body>
</html>
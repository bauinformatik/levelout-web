<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>LevelOut-Web</title>

<link rel="stylesheet" th:href="@{/css/main.css}" />
<script>
	var contextRoot = '[[@{/}]]'.replace(/\/$/, "");
	async function addProject() {
		var name = document.getElementById('projectName').value
		var schema = document.getElementById('projectSchema').value
		var exportLengthMeasurePrefix = document.getElementById('projectMeasurePrefix').value
		var description = document.getElementById('projectDescription').value

		const response = await fetch(contextRoot+"/project", {
			  method: 'PUT',
			  body: JSON.stringify({
				name:name,
				schema:schema,
				exportLengthMeasurePrefix:exportLengthMeasurePrefix,
				description:description
	    	  }),
			  headers: {
				'Content-type': 'application/json; charset=UTF-8',
			  }
	    })
	}

    function refreshPage(){
        window.location.reload();
    }

	function showHideProjectForm(show) {
		if(show) {
			document.getElementById('projectForm').style.display="block"
		}
		else {
			document.getElementById('projectForm').style.display="none"
		}
	}

	function update(data, elementId_suffix) {
		var element = document.getElementById("progress_"+elementId_suffix);
		element.style.display = "block";
		fetch(contextRoot+"/process/status/"+data.projectId+"/"+data.topicId, {
			method: "get"
		})
		.then(function(response) {
		  response.json().then(function(json){
		  	if (json.percentage >= 100 && json.actionState.toString() == "FINISHED") {
				console.log(json);
				element.style.width =  "100%";
				element.innerHTML = json.title + ":" + "100%";
				setTimeout(function(){
					alert("Finished Uploading");
					element.style.display = "none";
					refreshPage();
				},1000);
			} else {
				console.log(json);
				element.style.width = json.percentage * 1 + "%";
				element.innerHTML = json.title + ":" + json.percentage  + "%";
				update(json, elementId_suffix);
			}
		  });
		}).catch(err => console.error(err));
	}
	function hello(projectId) {
		const inputFile = document.getElementById("file_"+projectId);
		const formData = new FormData();
		for (const file of inputFile.files) {
			formData.append("file", file);
		}
		fetch(contextRoot+"/process/checkIn/"+projectId, {
			method: "post",
			body: formData
		})
		.then(function(response) {
		  // response.json() returns a promise, use the same .then syntax to work with the results
		  response.json().then(function(json){
			console.log(": "+json.percentage);
			update(json, projectId);
		  });
		}).catch(err => console.error(err));
	}
	</script>
</head>

<body>
<div style="text-align: center;">
<h1>
	<a href="https://www.uni-weimar.de/en/university/news/bauhausjournal-online/titel/levelout-project-launch-indoor-and-outdoor-smart-navigation/" target="_blank">
		LEVELOUT
	</a>
</h1>
</div>
	<div>
        <input th:attr="id=|file_0|" type="file"/>
		<button name="button" value="OK" type="button"
				th:attr="onclick=|hello('0')|">UPLOAD</button>

		<div th:attr="id=|progress_status_0|" class="progress_status">
			<div th:attr="id=|progress_0|" class="progress"></div>
		</div>
	</div>
	<table>
		<tr>
			<th>ID</th>
			<th>Project Name</th>
			<th>Project Description</th>
			<th>Actions</th>
		</tr>
		<tr th:each="project: ${projects}">
			<td th:text="${project.projectId}" />
			<td th:text="${project.name}" />
			<td th:text="${project.description}" />
			<td>
				<input th:attr="id=|file_${project.projectId}|" type="file"/>
				<button name="button" value="OK" type="button"
						th:attr="onclick=|hello('${project.projectId}')|">UPLOAD</button>

				<div th:attr="id=|progress_status_${project.projectId}|" class="progress_status">
					<div th:attr="id=|progress_${project.projectId}|" class="progress"></div>
				</div>
			</td>
		</tr>
	</table>

	<div id="projectForm" class="modal">
		<div class="modal-content">
			<div class="contact-form">
				<a class="close" onclick="showHideProjectForm(false)">&times;</a>
				<form action="/">
					<h2>Add Project</h2>
					<div>
						<input class="fname" type="text" id="projectName" placeholder="Project name" />
						<input type="text" id="projectSchema" placeholder="Schema (ifc2x3tc1 or ifc4)" />
						<input type="text" id="projectMeasurePrefix" placeholder="Export Measurement Prefix" />
					</div>
					<span>Description</span>
					<div>
						<textarea id="projectDescription" rows="4"></textarea>
					</div>
					<button onclick="addProject()">Submit</button>
				</form>
			</div>
		</div>
	</div>
</body>
</html>